<!DOCTYPE html><html lang="en"><head>&lt;!--  --&gt;<meta charset="utf-8"/><meta author="David Wilson"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="stylesheet" href="/css/bootstrap.min.css"/><link rel="stylesheet" href="/fonts/iosevka-aile/iosevka-aile.css"/><link rel="stylesheet" href="/fonts/jetbrains-mono/jetbrains-mono.css"/><link rel="stylesheet" href="/css/code.css"/><link rel="stylesheet" href="/css/site.css"/><script defer="defer" data-domain="systemcrafters.net" src="https://plausible.io/js/plausible.js"></script><title>How to Cut Emacs Startup Time in Half - System Crafters</title></head><body>&lt;div&gt;&lt;div class=&quot;blog-header&quot;&gt;&lt;div class=&quot;container&quot;&gt;&lt;div class=&quot;row align-items-center justify-content-between&quot;&gt;&lt;div class=&quot;col-sm-12 col-md-8&quot;&gt;&lt;div class=&quot;blog-title&quot;&gt;System Crafters&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;col-sm col-md&quot;&gt;&lt;div class=&quot;blog-description text-sm-left text-md-right text-lg-right text-xl-right&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;blog-masthead&quot;&gt;&lt;div class=&quot;container&quot;&gt;&lt;div class=&quot;row align-items-center justify-content-between&quot;&gt;&lt;div class=&quot;col-sm-12 col-md-12&quot;&gt;&lt;nav class=&quot;nav&quot;&gt;&lt;a class=&quot;nav-link&quot; href=&quot;/&quot;&gt;Home&lt;/a&gt; &lt;a class=&quot;nav-link&quot; href=&quot;/videos&quot;&gt;Videos&lt;/a&gt; &lt;a class=&quot;nav-link&quot; href=&quot;https://wiki.systemcrafters.net&quot;&gt;Wiki&lt;/a&gt; &lt;a class=&quot;nav-link&quot; href=&quot;https://store.systemcrafters.net?utm_source=sc-site-nav&quot;&gt;Merch Store&lt;/a&gt; &lt;a class=&quot;nav-link&quot; href=&quot;/support-the-channel&quot;&gt;Support The Channel&lt;/a&gt;&lt;/nav&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<div class="container"><div class="row"><div class="col-sm-12 blog-main"><div class="blog-post"><h1 class="blog-post-title">How to Cut Emacs Startup Time in Half</h1><p class="blog-post-meta"></p>&lt;div&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://youtu.be/9i_9hse_Y08&quot;&gt;Watch the video&lt;/a&gt; on YouTube!&lt;/li&gt;
&lt;li&gt;Check out the &lt;a href=&quot;https://github.com/daviwil/emacs-from-scratch/blob/d23348b4a52dde97f4f7cbcd66a519b5fd0a143c/Emacs.org&quot;&gt;final code&lt;/a&gt; on GitHub&lt;/li&gt;
&lt;li&gt;Episode 12 of the &lt;a href=&quot;../&quot;&gt;Emacs From Scratch&lt;/a&gt; series&lt;/li&gt;
&lt;/ul&gt;

&lt;h2&gt;&lt;a id=&quot;why-is-emacs-so-slow-to-start-up&quot; class=&quot;anchor&quot; href=&quot;#why-is-emacs-so-slow-to-start-up&quot;&gt;¶&lt;/a&gt;Why is Emacs so slow to start up?&lt;/h2&gt;&lt;p&gt;Is it actually slow with no config? Run &lt;kbd&gt;emacs -Q&lt;/kbd&gt; to find out!
&lt;/p&gt;

&lt;p&gt;So why is it so much slower with our configuration?
&lt;/p&gt;

&lt;h2&gt;&lt;a id=&quot;lets-find-out-how-long-its-taking&quot; class=&quot;anchor&quot; href=&quot;#lets-find-out-how-long-its-taking&quot;&gt;¶&lt;/a&gt;Let&apos;s find out how long it&apos;s taking!&lt;/h2&gt;&lt;p&gt;Add a function to &lt;kbd&gt;emacs-startup-hook&lt;/kbd&gt; to print out the duration of Emacs startup:
&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;emacs-lisp&quot;&gt;
(&lt;span class=&quot;org-keyword&quot;&gt;defun&lt;/span&gt; &lt;span class=&quot;org-function-name&quot;&gt;efs/display-startup-time&lt;/span&gt; ()
  (message &lt;span class=&quot;org-string&quot;&gt;&quot;Emacs loaded in %s with %d garbage collections.&quot;&lt;/span&gt;
           (format &lt;span class=&quot;org-string&quot;&gt;&quot;%.2f seconds&quot;&lt;/span&gt;
                   (float-time
                   (time-subtract after-init-time before-init-time)))
           gcs-done))

(add-hook &apos;emacs-startup-hook #&apos;efs/display-startup-time)

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;All startup behavior is happening in the &lt;kbd&gt;normal-top-level&lt;/kbd&gt; function!
&lt;/p&gt;

&lt;p&gt;A helpful manual page is &lt;a href=&quot;https://www.gnu.org/software/emacs/manual/html_node/elisp/Startup-Summary.html&quot;&gt;Summary: Sequence of Actions at Startup&lt;/a&gt;.
&lt;/p&gt;

&lt;h2&gt;&lt;a id=&quot;the-most-important-tip-dont-load-any-packages&quot; class=&quot;anchor&quot; href=&quot;#the-most-important-tip-dont-load-any-packages&quot;&gt;¶&lt;/a&gt;The most important tip: don&apos;t load any packages!&lt;/h2&gt;&lt;p&gt;&lt;kbd&gt;use-package&lt;/kbd&gt; gives you a few different ways to defer package loading:
&lt;/p&gt;

&lt;ul&gt;&lt;li&gt;&lt;kbd&gt;:hook&lt;/kbd&gt; - Package will be loaded the first time one of the hooks is invoked&lt;/li&gt;
&lt;li&gt;&lt;kbd&gt;:bind&lt;/kbd&gt; - Package will be loaded the first time one of the key bindings is used&lt;/li&gt;
&lt;li&gt;&lt;kbd&gt;:commands&lt;/kbd&gt; - Package will be loaded when one of the commands are used&lt;/li&gt;
&lt;li&gt;&lt;kbd&gt;:mode&lt;/kbd&gt; - Package will be loaded the first time a file with a particular extension is opened&lt;/li&gt;
&lt;li&gt;&lt;kbd&gt;:after&lt;/kbd&gt; - Load this package after other specific packages are loaded&lt;/li&gt;
&lt;li&gt;&lt;kbd&gt;:defer&lt;/kbd&gt; - If you don&apos;t use any of the other options, this one will defer loading until after startup&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There are a &lt;a href=&quot;https://github.com/jwiegley/use-package#getting-started&quot;&gt;few other options&lt;/a&gt; &lt;kbd&gt;use-package&lt;/kbd&gt; provides, but these are all the most likely ones you would use.
&lt;/p&gt;

&lt;p&gt;The strategy is to look at all of your &lt;kbd&gt;use-package&lt;/kbd&gt; expressions and decide whether it &lt;strong&gt;really&lt;/strong&gt; needs to be loaded immediately at startup!
&lt;/p&gt;

&lt;p&gt;If you want to make sure a package gets loaded at startup despite the use of any of the options above, use &lt;kbd&gt;:demand t&lt;/kbd&gt;.
&lt;/p&gt;

&lt;p&gt;Let&apos;s try it!
&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;emacs-lisp&quot;&gt;
&lt;span class=&quot;org-string&quot;&gt;&quot;fde&quot;&lt;/span&gt; &apos;(lambda () (&lt;span class=&quot;org-keyword&quot;&gt;interactive&lt;/span&gt;) (find-file (expand-file-name &lt;span class=&quot;org-string&quot;&gt;&quot;~/.emacs.d/Emacs.org&quot;&lt;/span&gt;)))

&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;&lt;a id=&quot;with-eval-after-load-can-be-useful&quot; class=&quot;anchor&quot; href=&quot;#with-eval-after-load-can-be-useful&quot;&gt;¶&lt;/a&gt;with-eval-after-load can be useful!&lt;/h2&gt;&lt;p&gt;&lt;kbd&gt;with-eval-after-load&lt;/kbd&gt; is a macro that causes a section of code to be executed only after a particular package gets loaded.
&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;emacs-lisp&quot;&gt;
(&lt;span class=&quot;org-keyword&quot;&gt;with-eval-after-load&lt;/span&gt; &apos;org
  (org-babel-do-load-languages
      &apos;org-babel-load-languages
      &apos;((emacs-lisp . t)
      (python . t)))

  (&lt;span class=&quot;org-keyword&quot;&gt;push&lt;/span&gt; &apos;(&lt;span class=&quot;org-string&quot;&gt;&quot;conf-unix&quot;&lt;/span&gt; . conf-unix) org-src-lang-modes))

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you need to split up your configuration into multiple sections, this is one way to ensure you don&apos;t accidentally cause a package to load too early!
&lt;/p&gt;

&lt;h2&gt;&lt;a id=&quot;tweaking-the-garbage-collector&quot; class=&quot;anchor&quot; href=&quot;#tweaking-the-garbage-collector&quot;&gt;¶&lt;/a&gt;Tweaking the garbage collector&lt;/h2&gt;&lt;p&gt;One other common performance trick is to reduce the number of times the garbage collector will run during the startup process.
&lt;/p&gt;

&lt;p&gt;Set the &lt;kbd&gt;gc-cons-threshold&lt;/kbd&gt; high at the beginning of your &lt;kbd&gt;init.el&lt;/kbd&gt;:
&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;emacs-lisp&quot;&gt;
&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;The default is 800 kilobytes.  Measured in bytes.&lt;/span&gt;
(&lt;span class=&quot;org-keyword&quot;&gt;setq&lt;/span&gt; gc-cons-threshold (* 50 1000 1000))

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then bring it back down at the end of your &lt;kbd&gt;init.el&lt;/kbd&gt;:
&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;emacs-lisp&quot;&gt;
&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;Make gc pauses faster by decreasing the threshold.&lt;/span&gt;
(&lt;span class=&quot;org-keyword&quot;&gt;setq&lt;/span&gt; gc-cons-threshold (* 2 1000 1000))

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Another option is to use Andrea Corrallo&apos;s &lt;a href=&quot;https://gitlab.com/koral/gcmh/&quot;&gt;gcmh package&lt;/a&gt; to manage it automatically.
&lt;/p&gt;
&lt;/div&gt;</div></div></div></div>&lt;footer class=&quot;blog-footer&quot;&gt;&lt;div class=&quot;container&quot;&gt;&lt;div class=&quot;row&quot;&gt;&lt;div class=&quot;col-sm col-md text-sm-left text-md-right text-lg-right text-xl-right&quot;&gt;&lt;p&gt;Made with Emacs 27.2 (Org mode 9.4.4)&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://systemcrafters.net/privacy-policy/&quot;&gt;Privacy Policy&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/footer&gt;&lt;script src=&quot;/js/bootstrap.bundle.min.js&quot;/&gt;</body></html>
