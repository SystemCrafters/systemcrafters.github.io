<!DOCTYPE html><html lang="en"><head><!--  --><meta charset="utf-8"/><meta author="David Wilson"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="stylesheet" href="/css/bootstrap.min.css"/><link rel="stylesheet" href="/fonts/iosevka-aile/iosevka-aile.css"/><link rel="stylesheet" href="/fonts/jetbrains-mono/jetbrains-mono.css"/><link rel="stylesheet" href="/css/code.css"/><link rel="stylesheet" href="/css/site.css"/><script defer="defer" data-domain="systemcrafters.net" src="https://plausible.io/js/plausible.js"></script><title>How to Cut Emacs Startup Time in Half - System Crafters</title></head><body><div><div class="blog-header"><div class="container"><div class="row align-items-center justify-content-between"><div class="col-sm-12 col-md-8"><div class="blog-title">System Crafters</div></div><div class="col-sm col-md"><div class="blog-description text-sm-left text-md-right text-lg-right text-xl-right"></div></div></div></div></div><div class="blog-masthead"><div class="container"><div class="row align-items-center justify-content-between"><div class="col-sm-12 col-md-12"><nav class="nav"><a class="nav-link" href="/">Home</a> <a class="nav-link" href="/videos">Videos</a> <a class="nav-link" href="https://wiki.systemcrafters.cc">Wiki</a> <a class="nav-link" href="https://store.systemcrafters.net?utm_source=sc-site-nav">Merch Store</a> <a class="nav-link" href="/support-the-channel">Support The Channel</a></nav></div></div></div></div></div><div class="container"><div class="row"><div class="col-sm-12 blog-main"><div class="blog-post"><h1 class="blog-post-title">How to Cut Emacs Startup Time in Half</h1><p class="blog-post-meta"></p><div><ul><li><a href="https://youtu.be/9i_9hse_Y08">Watch the video</a> on YouTube!</li>
<li>Check out the <a href="https://github.com/daviwil/emacs-from-scratch/blob/d23348b4a52dde97f4f7cbcd66a519b5fd0a143c/Emacs.org">final code</a> on GitHub</li>
<li>Episode 12 of the <a href="../">Emacs From Scratch</a> series</li>
</ul>

<h2><a id="why-is-emacs-so-slow-to-start-up" class="anchor" href="#why-is-emacs-so-slow-to-start-up">¶</a>Why is Emacs so slow to start up?</h2><p>Is it actually slow with no config? Run <kbd>emacs -Q</kbd> to find out!
</p>

<p>So why is it so much slower with our configuration?
</p>

<h2><a id="lets-find-out-how-long-its-taking" class="anchor" href="#lets-find-out-how-long-its-taking">¶</a>Let's find out how long it's taking!</h2><p>Add a function to <kbd>emacs-startup-hook</kbd> to print out the duration of Emacs startup:
</p>

<pre><code class="emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">efs/display-startup-time</span> ()
  (message <span class="org-string">"Emacs loaded in %s with %d garbage collections."</span>
           (format <span class="org-string">"%.2f seconds"</span>
                   (float-time
                   (time-subtract after-init-time before-init-time)))
           gcs-done))

(add-hook 'emacs-startup-hook #'efs/display-startup-time)

</code></pre>

<p>All startup behavior is happening in the <kbd>normal-top-level</kbd> function!
</p>

<p>A helpful manual page is <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Startup-Summary.html">Summary: Sequence of Actions at Startup</a>.
</p>

<h2><a id="the-most-important-tip-dont-load-any-packages" class="anchor" href="#the-most-important-tip-dont-load-any-packages">¶</a>The most important tip: don't load any packages!</h2><p><kbd>use-package</kbd> gives you a few different ways to defer package loading:
</p>

<ul><li><kbd>:hook</kbd> - Package will be loaded the first time one of the hooks is invoked</li>
<li><kbd>:bind</kbd> - Package will be loaded the first time one of the key bindings is used</li>
<li><kbd>:commands</kbd> - Package will be loaded when one of the commands are used</li>
<li><kbd>:mode</kbd> - Package will be loaded the first time a file with a particular extension is opened</li>
<li><kbd>:after</kbd> - Load this package after other specific packages are loaded</li>
<li><kbd>:defer</kbd> - If you don't use any of the other options, this one will defer loading until after startup</li>
</ul>

<p>There are a <a href="https://github.com/jwiegley/use-package#getting-started">few other options</a> <kbd>use-package</kbd> provides, but these are all the most likely ones you would use.
</p>

<p>The strategy is to look at all of your <kbd>use-package</kbd> expressions and decide whether it <strong>really</strong> needs to be loaded immediately at startup!
</p>

<p>If you want to make sure a package gets loaded at startup despite the use of any of the options above, use <kbd>:demand t</kbd>.
</p>

<p>Let's try it!
</p>

<pre><code class="emacs-lisp">
<span class="org-string">"fde"</span> '(lambda () (<span class="org-keyword">interactive</span>) (find-file (expand-file-name <span class="org-string">"~/.emacs.d/Emacs.org"</span>)))

</code></pre>

<h2><a id="with-eval-after-load-can-be-useful" class="anchor" href="#with-eval-after-load-can-be-useful">¶</a>with-eval-after-load can be useful!</h2><p><kbd>with-eval-after-load</kbd> is a macro that causes a section of code to be executed only after a particular package gets loaded.
</p>

<pre><code class="emacs-lisp">
(<span class="org-keyword">with-eval-after-load</span> 'org
  (org-babel-do-load-languages
      'org-babel-load-languages
      '((emacs-lisp . t)
      (python . t)))

  (<span class="org-keyword">push</span> '(<span class="org-string">"conf-unix"</span> . conf-unix) org-src-lang-modes))

</code></pre>

<p>If you need to split up your configuration into multiple sections, this is one way to ensure you don't accidentally cause a package to load too early!
</p>

<h2><a id="tweaking-the-garbage-collector" class="anchor" href="#tweaking-the-garbage-collector">¶</a>Tweaking the garbage collector</h2><p>One other common performance trick is to reduce the number of times the garbage collector will run during the startup process.
</p>

<p>Set the <kbd>gc-cons-threshold</kbd> high at the beginning of your <kbd>init.el</kbd>:
</p>

<pre><code class="emacs-lisp">
<span class="org-comment-delimiter">;; </span><span class="org-comment">The default is 800 kilobytes.  Measured in bytes.</span>
(<span class="org-keyword">setq</span> gc-cons-threshold (* 50 1000 1000))

</code></pre>

<p>Then bring it back down at the end of your <kbd>init.el</kbd>:
</p>

<pre><code class="emacs-lisp">
<span class="org-comment-delimiter">;; </span><span class="org-comment">Make gc pauses faster by decreasing the threshold.</span>
(<span class="org-keyword">setq</span> gc-cons-threshold (* 2 1000 1000))

</code></pre>

<p>Another option is to use Andrea Corrallo's <a href="https://gitlab.com/koral/gcmh/">gcmh package</a> to manage it automatically.
</p>
</div></div></div></div></div><footer class="blog-footer"><div class="container"><div class="row"><div class="col-sm col-md text-sm-left text-md-right text-lg-right text-xl-right"><p>Made with Emacs 27.2 (Org mode 9.4.4)</p><p><a href="privacy-policy/">Privacy Policy</a></p></div></div></div></footer><script src="/js/bootstrap.bundle.min.js"/></body></html>
